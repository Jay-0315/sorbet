<!DOCTYPE html>
<html lang="ko">
<head>
  <!-- Quill CSS -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <!-- Quill JS -->
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>


  <meta charset="UTF-8">
  <title>글쓰기 - Sorbet 게시판</title>
  <link rel="stylesheet" href="/css/createpost.css">
</head>
<body>
<div class="container">

  <form class="form-box" th:action="@{/createpost}" method="post" th:object="${post}" onsubmit="return submitContents();">

    <img src="/images/writingRabits.png" alt="끄적토끼" class="writing-image"/>
    <h1 class="use-crayon-font">TELL US YOUR STORY.</h1>

    <div class="form-group">
      <label th:for="*{title}">제목</label>
      <input type="text" th:field="*{title}" required />
    </div>

    <!-- 툴바 영역 -->
    <!-- 툴바 설정 -->
    <div id="toolbar">
  <span class="ql-formats">
    <select class="ql-font"></select>
    <select class="ql-size"></select>
  </span>
      <span class="ql-formats">
    <button class="ql-bold"></button>
    <button class="ql-italic"></button>
    <button class="ql-underline"></button>
  </span>
      <span class="ql-formats">
    <select class="ql-color"></select>
    <select class="ql-background"></select>
            <button class="ql-image"></button>
         <button class="ql-link"></button>
  </span>
      <span class="ql-formats">
    <button class="ql-align" value=""></button>
    <button class="ql-align" value="center"></button>
    <button class="ql-align" value="right"></button>
  </span>
    </div>

    <!-- Quill 에디터 -->
    <div id="editor" style="height: 400px;"></div>

    <script>
      const quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
          toolbar: { container: '#toolbar', handlers: { image: imageHandler } }
        }
      });

      async function imageHandler() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.click();

        input.onchange = async () => {
          const file = input.files?.[0];
          if (!file) return;

          // (옵션) 클라이언트에서 10MB 제한
          if (file.size > 10 * 1024 * 1024) {
            alert('이미지는 10MB 이하로 업로드해주세요.');
            return;
          }

          const form = new FormData();
          form.append('image', file); // 백엔드 @RequestParam("image")

          // CSRF 토큰을 쓰는 경우(Thymeleaf라면 보통 meta에 심어둠)
          const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
          const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

          const headers = {};
          if (csrfToken && csrfHeader) headers[csrfHeader] = csrfToken;

          // JWT 쓰는 경우
          // headers['Authorization'] = 'Bearer ' + localStorage.getItem('sorbet-token');

          try {
            const res = await fetch('/upload-image', {
              method: 'POST',
              body: form,
              headers,              // CSRF/JWT 필요시만 유효
              // credentials: 'include' // 세션/쿠키 쓸 때
            });
            if (!res.ok) throw new Error('서버 응답 오류');

            const data = await res.json(); // { url: "https://.../uploads/xxx.png" }
            const range = quill.getSelection(true);
            quill.insertEmbed(range.index, 'image', data.url, 'user');
            quill.setSelection(range.index + 1, 'silent');
          } catch (e) {
            console.error(e);
            alert('이미지 업로드 실패: ' + (e.message ?? ''));
          }
        };
      }

      // 전송시 HTML 저장
      function submitContents() {
        const html = quill.root.innerHTML;
        document.getElementById('hiddenContent').value = html;
        if (quill.getText().trim().length === 0) {
          alert('본문 내용을 입력해주세요.');
          return false;
        }
        return true;
      }
    </script>




    <div class="form-group">
      <label th:for="*{category}">카테고리</label>
      <select th:field="*{category}">
        <option value="">선택하세요</option>
        <option value="love">연애</option>
        <option value="friend">친구</option>
        <option value="life">인생</option>
        <option value="etc">기타</option>
      </select>
    </div>

    <div class="form-group">
      <label th:for="*{writer}">작성자 닉네임</label>
      <input type="text" th:field="*{writer}" readonly />
    </div>

    <div class="form-group">
      <label th:for="*{tags}">태그</label>
      <input type="text" th:field="*{tags}" />
    </div>

    <button type="submit" class="btn-submit">등록하기</button>
    <a href="/" class="btn-home">← 홈으로 돌아가기</a>

    <!-- 숨겨진 필드: HTML 내용 저장 -->
    <input type="hidden" name="content" id="hiddenContent">

  </form>

</div>










</body>
</html>
